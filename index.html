<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Uang Saku Santri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        /* Simple loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Aplikasi Uang Saku Santri</h1>
            <p class="text-gray-500 mt-2">Catat pemasukan dan pengeluaran uang saku dengan mudah.</p>
        </header>

        <!-- Total Saldo -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 text-center">
            <h2 class="text-lg font-semibold text-gray-600 mb-2">Total Uang yang Anda Pegang</h2>
            <p id="total-saldo-display" class="text-3xl font-bold text-green-600">Rp 0</p>
        </div>

        <!-- Form Tambah Santri -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Tambah Santri Baru</h2>
            <form id="add-santri-form" class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="w-full">
                    <label for="nama-santri" class="block text-sm font-medium text-gray-600 mb-1">Nama Santri</label>
                    <input type="text" id="nama-santri" placeholder="Contoh: Abdullah" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="w-full sm:w-auto">
                    <label for="saldo-awal" class="block text-sm font-medium text-gray-600 mb-1">Saldo Awal (Rp)</label>
                    <input type="number" id="saldo-awal" placeholder="Contoh: 50000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" required>
                </div>
                <button type="submit" id="add-santri-button" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold transition-colors">
                    Tambah
                </button>
            </form>
        </div>

        <!-- Search Bar and Daftar Santri -->
        <div>
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold">Daftar Santri</h2>
                 <div class="w-full max-w-xs">
                      <input type="text" id="search-santri" placeholder="Cari nama santri..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
            </div>
            <div id="santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Kartu Santri akan ditampilkan di sini -->
            </div>
            <div id="empty-state" class="text-center py-12">
                <div id="loader" class="loader mx-auto"></div>
                <p id="empty-state-text" class="text-gray-500 mt-4">Memuat data...</p>
            </div>
        </div>
    </div>

    <!-- Modal Transaksi -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl modal transform scale-95 opacity-0">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <form id="transaction-form">
                <input type="hidden" id="modal-santri-id">
                <input type="hidden" id="modal-transaction-type">
                <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-600 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="transaction-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" required>
                </div>
                <div class="mt-4">
                    <label for="transaction-note" class="block text-sm font-medium text-gray-600 mb-1">Catatan (Opsional)</label>
                    <input type="text" id="transaction-note" placeholder="Contoh: Beli buku" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-medium">Batal</button>
                    <button type="submit" id="confirm-button" class="text-white px-4 py-2 rounded-lg font-medium">Konfirmasi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Riwayat Transaksi -->
    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-lg p-6 rounded-xl shadow-2xl modal transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                <h2 id="history-modal-title" class="text-xl font-bold">Riwayat Transaksi</h2>
                <div class="flex items-center gap-2">
                    <button id="analyze-history-btn" class="text-sm bg-purple-100 text-purple-800 font-semibold px-3 py-2 rounded-lg hover:bg-purple-200">âœ¨ Analisis</button>
                    <button id="export-history-btn" class="text-sm bg-blue-100 text-blue-800 font-semibold px-3 py-2 rounded-lg hover:bg-blue-200">Export Excel</button>
                    <button id="close-history-button" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
            </div>
            <div id="history-content" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                <!-- Riwayat akan ditampilkan di sini -->
            </div>
            <div id="analysis-content" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <!-- Hasil analisis akan ditampilkan di sini -->
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl modal transform scale-95 opacity-0">
            <h2 class="text-xl font-bold mb-4">Konfirmasi Hapus</h2>
            <p id="delete-confirm-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-medium">Batal</button>
                <button type="button" id="confirm-delete-button" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { neon } from '@netlify/neon';
const sql = neon(); // automatically uses env NETLIFY_DATABASE_URL
const [post] = await sql`SELECT * FROM posts WHERE id = ${postId}`;

        document.addEventListener('DOMContentLoaded', () => {
            const addSantriForm = document.getElementById('add-santri-form');
            const santriListContainer = document.getElementById('santri-list');
            const emptyState = document.getElementById('empty-state');
            const emptyStateText = document.getElementById('empty-state-text');
            const loader = document.getElementById('loader');
            const totalSaldoDisplay = document.getElementById('total-saldo-display');
            const searchInput = document.getElementById('search-santri');

            // Modal elements
            const transactionModal = document.getElementById('transaction-modal');
            const modalTitle = document.getElementById('modal-title');
            const transactionForm = document.getElementById('transaction-form');
            const modalSantriId = document.getElementById('modal-santri-id');
            const modalTransactionType = document.getElementById('modal-transaction-type');
            const transactionAmount = document.getElementById('transaction-amount');
            const transactionNote = document.getElementById('transaction-note');
            const confirmButton = document.getElementById('confirm-button');
            const cancelButton = document.getElementById('cancel-button');

            // History Modal elements
            const historyModal = document.getElementById('history-modal');
            const historyModalTitle = document.getElementById('history-modal-title');
            const historyContent = document.getElementById('history-content');
            const closeHistoryButton = document.getElementById('close-history-button');
            const exportHistoryBtn = document.getElementById('export-history-btn');
            const analyzeHistoryBtn = document.getElementById('analyze-history-btn');
            const analysisContent = document.getElementById('analysis-content');

            // Delete Confirm Modal elements
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmText = document.getElementById('delete-confirm-text');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');
            let santriToDeleteId = null;

            // Firebase related variables
            let db, auth, userId, santriCollectionRef;
            let santriData = [];
            let unsubscribeSantri = null;

            // Initialize Firebase
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                santriCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'santri');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                emptyStateText.textContent = "Gagal menginisialisasi aplikasi.";
                loader.classList.add('hidden');
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    if (unsubscribeSantri) unsubscribeSantri();
                    setupFirestoreListener();
                } else {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        emptyStateText.textContent = "Gagal melakukan autentikasi.";
                        loader.classList.add('hidden');
                    }
                }
            });

            const setupFirestoreListener = () => {
                unsubscribeSantri = onSnapshot(santriCollectionRef, (snapshot) => {
                    santriData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    handleSearch(); 
                    renderTotalSaldo();
                    loader.classList.add('hidden');
                }, (error) => {
                    console.error("Error fetching data:", error);
                    emptyStateText.textContent = "Gagal memuat data dari database.";
                    loader.classList.add('hidden');
                });
            };

            const formatRupiah = (number) => {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
            };
            
            const renderTotalSaldo = () => {
                const total = santriData.reduce((sum, santri) => sum + santri.saldo, 0);
                totalSaldoDisplay.textContent = formatRupiah(total);
            };

            const renderSantriList = (listToRender = santriData) => {
                santriListContainer.innerHTML = '';
                
                if (listToRender.length === 0) {
                    if (searchInput.value) {
                         emptyStateText.textContent = `Santri dengan nama "${searchInput.value}" tidak ditemukan.`;
                    } else {
                         emptyStateText.textContent = 'Belum ada data santri. Silakan tambahkan santri baru.';
                    }
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    listToRender.forEach(santri => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-5 rounded-xl shadow-md flex flex-col justify-between';
                        card.innerHTML = `
                            <div>
                                <h3 class="text-lg font-bold truncate">${santri.nama}</h3>
                                <p class="text-2xl font-semibold text-blue-600 my-2">${formatRupiah(santri.saldo)}</p>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-2">
                                <button data-id="${santri.id}" class="deposit-btn w-full bg-green-100 text-green-800 text-sm font-semibold px-3 py-2 rounded-lg hover:bg-green-200">Setor</button>
                                <button data-id="${santri.id}" class="withdraw-btn w-full bg-orange-100 text-orange-800 text-sm font-semibold px-3 py-2 rounded-lg hover:bg-orange-200">Tarik</button>
                                <button data-id="${santri.id}" class="history-btn w-full bg-gray-100 text-gray-800 text-sm font-semibold px-3 py-2 rounded-lg hover:bg-gray-200">Riwayat</button>
                                <button data-id="${santri.id}" class="delete-btn w-full bg-red-100 text-red-800 text-sm font-semibold px-3 py-2 rounded-lg hover:bg-red-200">Hapus</button>
                            </div>
                        `;
                        santriListContainer.appendChild(card);
                    });
                }
            };
            
            const openModal = (modalElement) => {
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                    modalElement.querySelector('.modal').classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const closeModal = (modalElement) => {
                modalElement.querySelector('.modal').classList.add('scale-95', 'opacity-0');
                if (modalElement.id === 'history-modal') {
                    analyzeHistoryBtn.disabled = false;
                    analyzeHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 300);
            };
            
            const handleSearch = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredSantri = santriData.filter(santri => 
                    santri.nama.toLowerCase().includes(searchTerm)
                );
                renderSantriList(filteredSantri);
            };

            addSantriForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nama = document.getElementById('nama-santri').value;
                const saldoAwal = parseInt(document.getElementById('saldo-awal').value);
                
                const newSantri = {
                    nama: nama,
                    saldo: saldoAwal,
                    riwayat: [{
                        tanggal: new Date().toISOString(),
                        tipe: 'setor',
                        jumlah: saldoAwal,
                        catatan: 'Saldo Awal'
                    }]
                };

                try {
                    await addDoc(santriCollectionRef, newSantri);
                    searchInput.value = '';
                    addSantriForm.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Gagal menambahkan santri ke database.");
                }
            });

            santriListContainer.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                
                if (e.target.classList.contains('deposit-btn')) {
                    setupTransactionModal(id, 'setor');
                } else if (e.target.classList.contains('withdraw-btn')) {
                    setupTransactionModal(id, 'tarik');
                } else if (e.target.classList.contains('history-btn')) {
                    showHistory(id);
                } else if (e.target.classList.contains('delete-btn')) {
                    openDeleteConfirmModal(id);
                }
            });

            const setupTransactionModal = (id, type) => {
                const santri = santriData.find(s => s.id === id);
                modalSantriId.value = id;
                modalTransactionType.value = type;
                transactionForm.reset();
                
                if (type === 'setor') {
                    modalTitle.textContent = `Setor Uang untuk ${santri.nama}`;
                    confirmButton.className = 'bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700';
                } else {
                    modalTitle.textContent = `Tarik Uang untuk ${santri.nama}`;
                    confirmButton.className = 'bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700';
                }
                openModal(transactionModal);
            };
            
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = modalSantriId.value;
                const type = modalTransactionType.value;
                const amount = parseInt(transactionAmount.value);
                const note = transactionNote.value || (type === 'setor' ? 'Setoran' : 'Penarikan');

                const santri = santriData.find(s => s.id === id);
                if (!santri) return;

                if (type === 'tarik' && amount > santri.saldo) {
                    alert('Saldo tidak mencukupi!');
                    return;
                }
                
                const newSaldo = type === 'setor' ? santri.saldo + amount : santri.saldo - amount;
                const newTransaction = {
                    tanggal: new Date().toISOString(),
                    tipe: type,
                    jumlah: amount,
                    catatan: note
                };
                const updatedRiwayat = [newTransaction, ...santri.riwayat];
                
                try {
                    const santriDocRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'santri', id);
                    await updateDoc(santriDocRef, {
                        saldo: newSaldo,
                        riwayat: updatedRiwayat
                    });
                    closeModal(transactionModal);
                } catch (error) {
                    console.error("Error updating transaction: ", error);
                    alert("Gagal memperbarui transaksi.");
                }
            });

            const showHistory = (id) => {
                const santri = santriData.find(s => s.id === id);
                historyModalTitle.textContent = `Riwayat Transaksi - ${santri.nama}`;
                exportHistoryBtn.dataset.id = id;
                analyzeHistoryBtn.dataset.id = id;
                analysisContent.classList.add('hidden');
                analysisContent.innerHTML = '';
                
                const riwayat = santri.riwayat || [];
                if (riwayat.length === 0) {
                    historyContent.innerHTML = '<p class="text-gray-500">Tidak ada riwayat transaksi.</p>';
                    exportHistoryBtn.classList.add('hidden');
                    analyzeHistoryBtn.classList.add('hidden');
                } else {
                    exportHistoryBtn.classList.remove('hidden');
                    analyzeHistoryBtn.classList.remove('hidden');
                    historyContent.innerHTML = '';
                    riwayat.forEach(item => {
                        const isDeposit = item.tipe === 'setor';
                        const historyItem = document.createElement('div');
                        historyItem.className = 'flex justify-between items-start p-3 rounded-lg';
                        historyItem.innerHTML = `
                            <div>
                                <p class="font-semibold">${item.catatan}</p>
                                <p class="text-xs text-gray-500">${new Date(item.tanggal).toLocaleString('id-ID')}</p>
                            </div>
                            <p class="font-bold ${isDeposit ? 'text-green-600' : 'text-red-600'}">
                                ${isDeposit ? '+' : '-'}${formatRupiah(item.jumlah)}
                            </p>
                        `;
                        historyContent.appendChild(historyItem);
                    });
                }
                openModal(historyModal);
            };
            
            const openDeleteConfirmModal = (id) => {
                const santri = santriData.find(s => s.id === id);
                deleteConfirmText.innerHTML = `Apakah Anda yakin ingin menghapus data <strong>${santri.nama}</strong>? Tindakan ini tidak dapat diurungkan.`;
                santriToDeleteId = id;
                openModal(deleteConfirmModal);
            };

            confirmDeleteButton.addEventListener('click', async () => {
                if (santriToDeleteId) {
                    try {
                        const santriDocRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'santri', santriToDeleteId);
                        await deleteDoc(santriDocRef);
                        closeModal(deleteConfirmModal);
                        santriToDeleteId = null;
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        alert("Gagal menghapus santri.");
                    }
                }
            });

            const exportHistoryToExcel = (id) => {
                const santri = santriData.find(s => s.id === id);
                if (!santri || !santri.riwayat || santri.riwayat.length === 0) return;
                const data = santri.riwayat.map(item => ({
                    'Tanggal': new Date(item.tanggal).toLocaleString('id-ID'),
                    'Tipe': item.tipe === 'setor' ? 'Setor' : 'Tarik',
                    'Jumlah (Rp)': item.jumlah,
                    'Catatan': item.catatan
                }));
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Riwayat");
                worksheet["!cols"] = [{ wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 30 }];
                const sanitizedNama = santri.nama.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                XLSX.writeFile(workbook, `riwayat_${sanitizedNama}.xlsx`);
            };

            const callGeminiWithBackoff = async (payload) => {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                        if (i === 4) throw error;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            };

            const analyzeHistory = async (id) => {
                const santri = santriData.find(s => s.id === id);
                if (!santri || !santri.riwayat || santri.riwayat.length < 2) {
                    analysisContent.innerHTML = '<p class="text-gray-600">Analisis memerlukan setidaknya dua transaksi.</p>';
                    analysisContent.classList.remove('hidden');
                    return;
                }
                analysisContent.classList.remove('hidden');
                analysisContent.innerHTML = '<p class="text-gray-600 animate-pulse">âœ¨ Menganalisis pengeluaran...</p>';
                analyzeHistoryBtn.disabled = true;
                analyzeHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                const transactionHistory = santri.riwayat.slice(0, 15)
                    .map(t => `- ${new Date(t.tanggal).toLocaleDateString('id-ID')}, ${t.tipe === 'setor' ? 'Pemasukan' : 'Pengeluaran'} ${formatRupiah(t.jumlah)}, Catatan: ${t.catatan}`)
                    .join('\n');
                const systemPrompt = "Anda adalah penasihat keuangan yang ramah untuk santri. Analisis riwayat transaksi, berikan ringkasan singkat (2-3 kalimat) dan satu saran praktis yang memotivasi. Gunakan bahasa Indonesia yang santai dan mudah dipahami. Format jawaban dengan judul 'Ringkasan:' dan 'Saran Bijak:'.";
                const userQuery = `Data keuangan santri bernama ${santri.nama}:\nSaldo Saat Ini: ${formatRupiah(santri.saldo)}\n\n15 Transaksi Terakhir:\n${transactionHistory}\n\nTolong berikan analisisnya.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const generatedText = await callGeminiWithBackoff(payload);
                    const formattedText = generatedText.replace(/\n/g, '<br>').replace(/Ringkasan:/g, '<strong>Ringkasan:</strong>').replace(/Saran Bijak:/g, '<strong>Saran Bijak:</strong>');
                    analysisContent.innerHTML = `<p class="text-gray-700 text-sm">${formattedText}</p>`;
                } catch (error) {
                    analysisContent.innerHTML = `<p class="text-red-600 text-sm">Maaf, terjadi kesalahan saat membuat analisis. Coba lagi nanti.</p>`;
                    console.error("Gemini API call failed:", error);
                } finally {
                    analyzeHistoryBtn.disabled = false;
                    analyzeHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };
            
            searchInput.addEventListener('input', handleSearch);
            exportHistoryBtn.addEventListener('click', (e) => e.target.dataset.id && exportHistoryToExcel(e.target.dataset.id));
            analyzeHistoryBtn.addEventListener('click', (e) => e.target.dataset.id && analyzeHistory(e.target.dataset.id));
            cancelButton.addEventListener('click', () => closeModal(transactionModal));
            closeHistoryButton.addEventListener('click', () => closeModal(historyModal));
            cancelDeleteButton.addEventListener('click', () => closeModal(deleteConfirmModal));
        });
    </script>
</body>
</html>

